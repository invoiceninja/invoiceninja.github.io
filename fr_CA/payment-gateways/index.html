<!DOCTYPE html>
<html lang="fr_CA">

<head>
    <title>Free Source Available Invoicing, Expenses &amp; Time-Tracking | Invoice Ninja</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="referrer" content="always">
    <link rel="canonical" href="https://invoiceninja.github.io/fr_CA/payment-gateways">
    <meta name="description" content="The leading free source available online invoicing app for freelancers &amp; businesses. Invoice, accept payments, track expenses, &amp; time-tasks">
    <meta name="docsearch:language" content="fr_CA" />
    <meta name="docsearch:version" content="v1.0.1" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <link rel="stylesheet" href="/assets/build/css/main.css?id=2efe3772345fcb6092f53238a2931c53">
    <link rel="stylesheet" href="/assets/build/css/docsearch.min.css?id=7cb95be37902ccc193627d8e95120feb" />
    <link rel="stylesheet" href="/assets/build/css/video-js.css?id=725ac2206fba737ebf9405ec02f91c81" />
    <link rel="icon" type="image/png" href="/assets/images/favicon.png">

    <script src="/assets/build/js/lunr.min.js?id=4b684389f3179bfb6f7048d14e2da4e9"></script>
    <script src="/assets/build/js/video.min.js?id=f7f891a09d5fe7da5b498a117486aca9"></script>
    <script src="/assets/build/js/videojs-dash.min.js?id=a5cb38deff90188bdfd2e8cbe7c95128"></script>

        <script type="text/javascript" src="/fr_CA.js"></script>
    <script type="text/javascript" src="/fr_CA_index.js"></script>
        <style>
      .search-wrapper {
        /* position: relative; */
        /* display: inline-block; */
        /* max-width: 50%;  */
      }

        .results-list {
        position: absolute;
        background-color: white;
        /* border: 1px solid #ccc; */
        padding: 0;
        margin: 0;
        list-style: none;
        max-height: 400px;
        max-width:800px;
        overflow-y: scroll;
        width: calc(100% - 2px);
        z-index: 10000;
        top: 100%; /* This will pin the dropdown to the bottom of the search input */
        left: auto;
        right: auto;
        border-top-left-radius: 0; 
        border-top-right-radius: 0;
        border-bottom-left-radius: 0.25rem;
        /* /* border-bottom-right-radius: 0.25rem; */
        }

        .results-list li {
        padding: 8px;
        cursor: pointer;
        }

        .results-list li:hover {
        background-color: #eee;
        }
        .result-item {
          padding: 16px;
          cursor: pointer;
          border-bottom: 1px solid #f0f0f0;
        }

        .result-item:last-child {
          border-bottom: none;
        }

        .result-item:hover {
          background-color: #f9f9f9;
        }

        .result-title {
          font-size: 16px;
          font-weight: bold;
          margin-bottom: 4px;
        }

        .result-description {
          font-size: 14px;
          color: #777;
        }

    </style>
 
   <script>

      document.addEventListener('DOMContentLoaded', function () {

      let idx = lunr.Index.load(data);

      const input = document.getElementById('search-input');
      const resultsList = document.getElementById('results-list');

      input.addEventListener('input', function () {
        const query = input.value.toLowerCase().trim();

        const results = idx.search(query);

        // Clear previous results
        resultsList.innerHTML = '';

        if (query === '') {
          resultsList.style.display = 'none';
          return;
        }
        // Populate the dropdown results list
        results.forEach(result => {
        
          const matchedDoc = documents.find(doc => doc.id == result.ref);
        
          const li = document.createElement('li');
          li.className = 'result-item';

          const a = document.createElement('a');
          a.href = matchedDoc.uri;
          a.style.textDecoration = 'none'; // Remove the default underline from the link

          const div = document.createElement('div');
          div.className = 'result-title';
          div.textContent = matchedDoc.title + ' | ' + matchedDoc.sub_title;
          a.appendChild(div);

          const div2 = document.createElement('div');
          div2.className = 'result-description';
          div2.textContent = matchedDoc.body.substring(0, 150) + '...';
          a.appendChild(div2);

          li.appendChild(a);
          resultsList.appendChild(li);

        });

        resultsList.style.display = results.length ? 'block' : 'none';

      });

      // Hide the dropdown results list when clicking outside the search box
      document.addEventListener('click', function (event) {
        if (!event.target.closest('#search-box')) {
          resultsList.style.display = 'none';
        }
      });

      input.addEventListener('keydown', function (e) {
        if (e.key === 'ArrowUp') {
          e.preventDefault(); // Prevent scrolling the page
          selectResult(selectedIndex - 1);
        } else if (e.key === 'ArrowDown') {
          e.preventDefault(); // Prevent scrolling the page
          selectResult(selectedIndex + 1);
        } else if (e.key === 'Enter' && selectedIndex >= 0 && selectedIndex < resultsList.children.length) {
          
          window.location.href = resultsList.children[selectedIndex].children[0].href;
        }
      });

      let selectedIndex = -1;

      function selectResult(index) {
        // Deselect the previously selected item
        if (selectedIndex >= 0 && selectedIndex < resultsList.children.length) {
          resultsList.children[selectedIndex].classList.remove('bg-gray-200');
        }

        selectedIndex = index;

        // Select the new item
        if (selectedIndex >= 0 && selectedIndex < resultsList.children.length) {
          resultsList.children[selectedIndex].classList.add('bg-gray-200');

          // Smoothly scroll to the selected item
          resultsList.children[selectedIndex].scrollIntoView({
            block: 'nearest',
            behavior: 'smooth'
          });
        }
      }


      document.addEventListener('keydown', (e) => {

        if (e.key.toLowerCase() == 'k' && e.ctrlKey) {
              // Add your code here
              
            e.preventDefault(); // Prevent scrolling the page

            console.log("yoyo");

              input.focus();
          }
      });


    });



  </script>

    <link rel="stylesheet"
          href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/agate.min.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>

    <script>hljs.highlightAll();</script>
</head>

<meta name="locale" content="fr_CA">

<nav class="py-4 sticky top-0 z-40 lg:z-50 w-full bg-white border-b">
    <div id="navigation-content" class="grid grid-cols-12">
        <div class="float-left pl-4 col-span-2">
            <a href="/fr_CA" id=""><img class="object-contain h-10 mt-2	" src="/assets/images/logo-rounded.png" alt="Invoice Ninja logo" />
            </a>
        </div>
                    <div class="search-wrapper w-full col-span-5 flex justify-center" id="search-box">
                <input type="text" id="search-input" placeholder="Search Invoice Ninja... (Ctrl K)" class="h-14 text-lg focus:outline-none rounded-mdsm:max-w-xs">
                <ul id="results-list" class="results-list"></ul>
            </div>
            <!-- <input type="text" placeholder="Recherche rapide" id="topSearchBox" data-lpignore="true"
                class="pb-1 border-b hover:border-ninja-blue focus:border-ninja-blue focus:outline-none"> -->
                <div id="right-side-items" class="text-sm w-full col-span-5 flex flex-grow justify-end pr-5">
            <div class="hidden md:hidden lg:block md:space-x-2">
                <span>
                    <a href="/fr_CA/user-guide" class="py-2 border-b border-transparent hover:border-ninja-blue">Guide de l&#039;utilisateur</a>
                </span>
                <span>
                    <a href="/fr_CA/self-host-installation" class="py-2 border-b border-transparent hover:border-ninja-blue">Auto-hébergement</a>
                </span>
                <span>
                    <a href="https://api-docs.invoicing.co/" target="_blank" class="py-2 border-b border-transparent hover:border-ninja-blue">Documentation API</a>
                </span>
                <span>
                    <a target="_blank" href="https://app.invoicing.co" class="px-5 py-2 border rounded-full hover:border-ninja-blue">Accéder à l&#039;application</a>
                </span>
                <span>
                    <select id="locale" onchange="this.options[this.selectedIndex].value && (window.location = '/' + this.options[this.selectedIndex].value);" class="mt-2 rounded-md border-0 py-1.5 pl-1 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm sm:leading-6">
                        <option value="en">EN</option>
                        <option value="fr_CA">Fr (CA)</option>
                    </select>
                </span>
            </div>
            <div class="flex flex-col lg:hidden">
                <button id="mobile-menu-toggle" class="focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
            </div>

        </div>
    </div>
    <div id="mobile-menu" class="hidden px-4 pt-4 flex flex-col">
        <a href="/fr_CA/getting-started" class="py-2 border-b border-transparent hover:border-ninja-blue"> Guide de l&#039;utilisateur </a>
        <a href="/fr_CA/self-host-installation" class="py-2 border-b border-transparent hover:border-ninja-blue">Auto-hébergement</a>
        <a href="https://api-docs.invoicing.co/" target="_blank" class="py-2 border-b border-transparent hover:border-ninja-blue"> Documentation API </a>
        <a href="https://app.invoicing.co" target="_blank" class="py-2 border-b border-transparent hover:border-ninja-blue"> Accéder à l&#039;application</a>
        <select id="locale_mobile" onchange="this.options[this.selectedIndex].value && (window.location = '/' + this.options[this.selectedIndex].value);" class="mt-2 rounded-md border-0 py-1.5 pl-3 pr-5 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm sm:leading-6">
            <option value="en">EN</option>
            <option value="fr_CA">Fr (CA)</option>
        </select>
    </div>
</nav>

<script>
    let element = document.getElementById('locale_mobile');
    element.value = document.querySelector('meta[name="locale"]').content;

    let element2 = document.getElementById('locale');
    element2.value = document.querySelector('meta[name="locale"]').content;
</script>

<body class="font-sans antialiased text-gray-900 bg-white ">
        <div class="hidden top-0 absolute z-40 bg-white w-full h-screen" id="mobile-menu-overlay">
       <div class="p-6 flex items-top justify-between">
           <div>
                                  <div clasS="mb-8">
                       <a class="block hover:text-ninja-blue font-semibold uppercase "
                          href="/fr_CA/developer-guide"></a>

                       <div class="mt-2">
                                                          <a class="block hover:text-ninjaGuide du développeur-blue py-1 "
                                  href="/fr_CA/developer-guide">Premiers pas</a>
                                                          <a class="block hover:text-ninjaGuide du développeur-blue py-1 "
                                  href="/fr_CA/payment-gateways">Passerelles de paiement</a>
                                                          <a class="block hover:text-ninjaGuide du développeur-blue py-1 "
                                  href="/fr_CA/statics">Variables statiques</a>
                                                          <a class="block hover:text-ninjaGuide du développeur-blue py-1 "
                                  href="https://api-docs.invoicing.co/">Docs API</a>
                                                  </div>
                   </div>
                          </div>
           <div>
                <button onclick="document.getElementById('mobile-menu-overlay').classList.add('hidden');">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
           </div>
       </div>
    </div>

    <div class="max-w-12xl grid grid-cols-12 py-2 px-2 lg:mx-auto">
        <div class="hidden space-y-6 md:block lg:col-span-2">
            <div class="hidden lg:block fixed mt-2 h-full overflow-y-auto pb-32 pr-16 pl-4">
                                    <div clasS="mb-8">
                        <a class="block hover:text-ninja-blue font-semibold uppercase "
                          href="/fr_CA/developer-guide">Guide du développeur</a>


                        <div class="mt-2">
                                                            <a class="block hover:text-ninja-blue py-1 "
                                  href="/fr_CA/developer-guide">Premiers pas</a>
                                                            <a class="block hover:text-ninja-blue py-1 "
                                  href="/fr_CA/payment-gateways">Passerelles de paiement</a>
                                                            <a class="block hover:text-ninja-blue py-1 "
                                  href="/fr_CA/statics">Variables statiques</a>
                                                            <a class="block hover:text-ninja-blue py-1 "
                                  href="https://api-docs.invoicing.co/">Docs API</a>
                                                    </div>
                    </div>
                            </div>
        </div> <!-- End of sidebar -->

        <div class="col-span-12 md:col-span-8 prose mx-auto max-w-max" id="page-content">
            <div class="block lg:hidden flex flex-col mb-4 lg:mb-0">
                <button onclick="document.getElementById('mobile-menu-overlay').classList.remove('hidden');">&#8592; Documentation</button>
            </div>

            <h2>Ajout de passerelles de paiement</h2>

<p><strong>Modèle de pilote de paiement.</strong></p>

<p>Alors vous voulez créer un pilote de paiement pour Invoice Ninja, mais vous ne savez pas par où commencer? La première étape serait de nous contacter directement sur Slack https://invoiceninja.slack.com et d'avoir une discussion en temps réel avec nous afin que nous puissions vous aider à démarrer rapidement et à construire votre pilote de la manière la plus efficace possible. Nous contacter au préalable nous permettra également de nous assurer que votre code peut être fusionné avec le dépôt officiel, car nous en assurerons la maintenance à l'avenir.</p>

<p>Prêt? Allons-y!</p>

<h3>Étape 1. Configurer l'environnement</h3>

<p>Vous devriez mettre à jour votre code pour être à jour avec la branche <a href="https://github.com/invoiceninja/invoiceninja/tree/v5-develop">v5-develop</a>.</p>

<p>Vous voudrez ensuite créer votre propre branche pour votre pilote, c'est-à-dire.</p>

<pre><code>git branch my_payment_driver
</code></pre>

<h3>Étape 2. Ajout de la passerelle dans la table des passerelles</h3>

<p>Créons un fichier de migration qui insérera un enregistrement identifiant la passerelle.</p>

<pre><code>php artisan make:migration my_new_gateway
</code></pre>

<p>Ouvrons ce fichier et dans la méthode up() créons notre nouvel enregistrement de passerelle</p>

<p>Init une nouvelle instance de gateway</p>

<pre><code>$gateway = new Gateway;
$gateway-&gt;name = 'Passerelle Élégante'; 
$gateway-&gt;key = Str::lower(Str::random(32)); 
$gateway-&gt;provider = ‘PasserelleÉlégante’;
$gateway-&gt;is_offsite = true;
$gateway-&gt;fields = new \\stdClass;
$gateway-&gt;visible = true;
$gateway-&gt;site_url = ‘https://stripe.com’;
$gateway-&gt;default_gateway_type_id = 1;
$gateway-&gt;save();
</code></pre>

<h4>Propriétés du Gateway</h4>

<ul>
<li>name: Le nom de votre passerelle</li>
<li>key: Une clé de passerelle alphanumérique aléatoire de 32 caractères (Type: string)</li>
<li>provider: Ceci est une chaîne en camel case qui est utilisée pour initialiser votre pilote de paiement. Nous ajoutons la chaîne Driver à cette classe, donc si votre pilote de paiement est FancyGatewayDriver, alors votre fournisseur sera FancyGateway. (Type: string)</li>
<li>is_offsite: Spécifie si ce pilote de paiement redirige l'utilisateur vers une autre page pour effectuer le paiement. Paypal Express, par exemple, redirige vers Paypal, puis renvoie l'utilisateur une fois le paiement terminé (Type: bool)</li>
<li>fields: Un objet stdClass de valeurs clés qui définit les paramètres utilisateur requis pour la passerelle, c'est-à-dire les clés API, les secrets, etc. Tous ces champs sont des chaînes à l'exception de testMode qui est un booléen et indique si la passerelle est en mode test. (Type stdClass)</li>
<li>visible: Définit si la passerelle doit être visible dans l'interface utilisateur (Type: bool)</li>
<li>site_url: Un champ URL qui permet à l'utilisateur d'accéder directement à la page de la passerelle pour plus d'informations (Type: string, url)</li>
<li>default_gateway_type_id: Si votre passerelle propose plusieurs moyens de paiement, c'est-à-dire carte de crédit, transfert bancaire, etc., vous voudrez alors sélectionner une méthode par défaut. La liste des méthodes définies se trouve sur le modèle GatewayType comme suit:</li>
</ul>

<pre><code>const CARTE_CREDIT = 1;
const TRANSFERT_BANCAIRE = 2;
const PAYPAL = 3;
const CRYPTO = 4;
const PERSONNALISE = 5;
const ALIPAY = 6;
const SOFORT = 7;
const APPLE_PAY = 8;
const SEPA = 9;
const CREDIT = 10;
</code></pre>

<h3>Étape 3. Obtenez et définissez le modèle App\Models\Gateway.php</h3>

<p>Deux méthodes doivent être ajoutées à :</p>

<ol>
<li><code>getHelp()</code> renvoie un lien vers la page d'aide des passerelles. Nous affichons un lien dans l'interface utilisateur pour que l'utilisateur puisse ouvrir une page Web directe vers la passerelle.</li>
<li><code>getMethods()</code> renvoie un tableau des types de passerelle pris en charge (c'est-à-dire les méthodes de paiement), si la passerelle prend en charge les remboursements et la facturation par jeton, ainsi que les métadonnées du webhook. La structure du tableau ressemble à ceci :</li>
</ol>

<pre><code class="language-php">[
  [GatewayType::CREDIT_CARD =&gt; ['remboursement' =&gt; true, 'facturation_par_jeton' =&gt; true]],
  [GatewayType::BANK_TRANSFER =&gt; ['remboursement' =&gt; true, 'facturation_par_jeton' =&gt; true, 'webhooks' =&gt; ['source.chargeable']]]
];
</code></pre>

<p>Le tableau est stocké dans un bloc case/switch, qui change en fonction de la propriété gateway->id.</p>

<h3>Étape 4. Commencer le travail sur le Pilote de Paiement</h3>

<p>Tous les pilotes de paiement doivent étendre la classe BaseDriver qui étend elle-même la classe abstraite AbstractPaymentDriver qui impose les méthodes requises suivantes. Nous avons ébauché un exemple de classe de pilote de paiement et des fichiers de vue qui peuvent être téléchargés <a href="/assets/files/PaymentDriver.zip">ici</a></p>

<pre><code class="language-php">abstract public function autoriserVoir(array $data);
</code></pre>

<pre><code class="language-markdown">fonction publique abstraite authorizeResponse(Requête $request);
</code></pre>

<p>Note : Le texte ne contient pas de balises HTML, de liens ou d'images en format Markdown à conserver ou traduire.</p>

<pre><code>fonction publique abstraite processPaymentView(array $data);
</code></pre>

<pre><code>fonction abstraite publique processPaymentResponse (Requête $request);

fonction publique abstraite refund(Paiement $paiement, $montant_remboursement, $retour_reponse_client = false);

fonction publique abstraite tokenBilling(ClientGatewayToken $cgt, PaymentHash $payment_hash);

fonction publique abstraite setPaymentMethod($payment_method_id);
</code></pre>

<ul>
<li>authorizeView() retourne une vue qui permet la capture d'un jeton pour une méthode de paiement spécifique, c'est-à-dire la Carte de Crédit ou le Virement Bancaire</li>
</ul>

<p>Pour comprendre les dispositions de l'interface utilisateur, il est intéressant d'examiner les dispositions des autres pilotes de paiement dans resources/views/portal/ninja2020/gateways.</p>

<p>Toutes les mises en page sont basées sur la suivante:</p>

<pre><code class="language-php">@extends('portal.ninja2020.layout.payments', ['gateway_title' =&gt; ctrans('texts.credit_card'), 'card_title' =&gt; ctrans('texts.credit_card')])

</code></pre>

<ul>
<li>authorizeReponse() traite la réponse de la passerelle et si elle est réussie, crée un enregistrement <code>ClientGatewayToken</code> suivi du retour de l'utilisateur à la route suivante</li>
</ul>

<pre><code class="language-php">return redirect()-&gt;route('client.moyens_de_paiement.index');
</code></pre>

<p><strong>Note :</strong> Since it's a code block, only the comment has been translated.</p>

<ul>
<li>processPaymentView() retourne une vue permettant la capture d'un paiement","39":"* processPaymentResponse() traite la réponse de la passerelle et, si elle est réussie, crée un enregistrement <code>Payment</code> suivi du retour de l'utilisateur à la route de paiement ici:</li>
</ul>

<pre><code class="language-php">return redirect()-&gt;route('client.payments.show', ['payment' =&gt; $this-&gt;stripe-&gt;encodePrimaryKey($payment-&gt;id)]);
</code></pre>

<ul>
<li>refund() tente d'effectuer un remboursement et prend trois paramètres,</li>
</ul>

<ol>
<li>Le modèle de paiement (Collection)</li>
<li>Le montant du remboursement (Flottant)</li>
<li>Si la réponse nécessite une réponse du client (Booléen)</li>
</ol>

<ul>
<li><p>tokenBilling() tente de traiter un paiement avec jeton pour un montant donné</p></li>
<li><p>setPaymentMethod() cette méthode est utilisée pour définir la méthode de paiement dans la classe du pilote, cela est nécessaire dans les classes de passerelle où il y a plusieurs options de méthode de paiement dans la passerelle, par exemple. Carte de crédit, virement bancaire.</p></li>
</ul>

<p>La classe BaseDriver elle-même contient plusieurs méthodes d'assistance qui permettent la création d'enregistrements de paiement dans Invoice Ninja, ceux-ci sont définis comme suit:</p>

<h2>Code</h2>

<pre><code class="language-php">// Ne traduisez pas cette partie avec les balises PHP et retournez-public function storeGatewayToken(array $data, array $additional = []): ?ClientGatewayToken
</code></pre>

<p>Voici comment appeler cette méthode en utilisant un exemple concret:</p>

<pre><code class="language-php">$data = [
    'gateway_id' =&gt; 1,
    'client_id' =&gt; 2
];

$clientGatewayToken = $this-&gt;storeGatewayToken($data, ['user' =&gt; $this-&gt;user]);
</code></pre>

<p>Notez que voyez pouvez ajouter des informations supplémentaires en utilisant le deuxième argument de cette fonction, qui est facultatif.</p>

<p>Cette méthode est utilisée pour stocker un jeton généré par une passerelle de paiement, elle nécessite un tableau de paramètres avec la définition suivante :</p>

<pre><code class="language-php">[
    'jeton', // (chaîne de caractères),
    'identifiant_methode_paiement', // (ex : GatewayType::CREDIT_CARD),
    'metadonnees_paiement', // Objet stdClass défini ci-dessous
]
</code></pre>

<p>$payment_meta = new &#92;stdClass;
$payment_meta->exp_month = (string) $method->card->exp_month;
$payment_meta->exp_year = (string) $method->card->exp_year;
$payment_meta->brand = (string) $method->card->brand;
$payment_meta->last4 = (string) $method->card->last4;
$payment_meta->type = GatewayType::CREDIT_CARD;</p>

<pre><code><br />Pour améliorer l'abstraction, nous encourageons le développement de l'implémentation de la passerelle de paiement réelle dans son propre espace de noms. Une fois que vous avez terminé le traitement d'une réponse de passerelle, vous devrez effectuer un travail supplémentaire, cela pourrait inclure :

1. Retourner une réponse de paiement réussie à l'utilisateur final
2. Traiter un remboursement
3. Stocker un jeton de passerelle client
4. Traiter une réponse de paiement échoué à l'utilisateur final

Invoice ninja fournit le point d'entrée pour ceux-ci dans la classe BaseDriver, les données exactes requises sont spécifiées comme ci-dessus, le reste est fusionné à partir des données déjà présentes dans le pilote lui-même.

#### 1. Gérer une réponse de paiement réussie

Invoice ninja utilise une petite classe de liaison appelée PaymentHash, qui relie les métadonnées de paiement à un hachage. Une fois que vous êtes revenu de votre passerelle, vous devrez réhydrater l'objet de hachage de paiement. Il vous sera retourné par la passerelle dans la variable de demande `payment_hash` en utilisant une recherche binaire comme suit :

```php
$payment_hash = PaymentHash::whereRaw('BINARY `hash`= ?', [$request-&gt;input('payment_hash')])-&gt;firstOrFail();
</code></pre>

<p>À ce stade, vous devrez créer un enregistrement de paiement, cela peut être transmis directement à la méthode BaseDriver définie ci-dessous</p>

<pre><code class="language-php">public function createPayment(array $data, $status = Payment::STATUS_COMPLETED): Payment
</code></pre>

<p>Note : La traduction n'est pas requise pour les blocs de code, les balises HTML et les attributs en ligne tels que les liens et les images.</p>

<p>Le tableau de données ici nécessite les propriétés suivantes à être transmises depuis votre pilote de paiement personnalisé</p>

<pre><code class="language-php">[
    'gateway_type_id', // (c.-à-d. GatewayType::CREDIT_CARD)
    'amount', // (float) voir ci-dessous
    'payment_type', // (c.-à-d. PaymentType::CREDIT_CARD_OTHER)
    'transfaction_reference',
]
</code></pre>

<p>L'élément clé du montant est issu du hachage de paiement, la requête suivante devrait être utilisée pour déterminer le montant</p>

<pre><code class="language-php">array_sum(array_column($payment_hash-&gt;invoices(), 'montant')) + $payment_hash-&gt;total_frais;
</code></pre>

<p>N.B. Dans le bloc de code ci-dessus, j'ai traduit uniquement le commentaire. Ne traduisez pas le code dans les blocs de code.</p>

<p>En plus de créer l'enregistrement de paiement, nous recommandons fortement de consigner la sortie complète de la passerelle pour permettre le débogage à des fins futures, cela se fait via SystemLogger::job() qui est défini comme suit</p>

<pre><code class="language-php">public function __construct(array $log, int $category_id, int $event_id, int $type_id, ?Client $client)
</code></pre>

<p>L'objet tableau est la réponse de la passerelle, regroupée avec toutes autres métadonnées que vous souhaitez ajouter. Les propriétés restantes sont les valeurs constantes définies dans SystemLog, celles-ci définissent la catégorie, l'événement et le type de journal. N'hésitez pas à créer des catégories supplémentaires en utilisant le modèle présent dans la classe SystemLog.</p>

<h4>2. Traiter un remboursement</h4>

<p>La méthode de remboursement est implémentée dans votre classe PaymentDriver avec la méthode suivante</p>

<pre><code class="language-php">public function refund(Payment $payment, $refund_amount, $return_client_response = false);
</code></pre>

<p>Vous pourriez avoir besoin de la classe $payment pour passer la transaction_reference à votre passerelle, avec le refund_amount, l'objet de retour ici est un simple tableau de données en cas de succès, ou lancer une exception avec un message approprié.</p>

<h4>3. Enregistrer un jeton de passerelle client</h4>

<p>Une fois que vous avez généré un jeton de passerelle, vous devrez le stocker. Une méthode d'assistance dans le BaseDriver est définie ici :</p>

<pre><code class="language-php">public function storeGatewayToken(array $data, array $additional = []): ?ClientGatewayToken
</code></pre>

<p>Les propriétés requises pour le tableau de données sont les suivantes :</p>

<pre><code class="language-php">[
  'jeton',
  'identifiant_methode_paiement',
  'meta_paiement',
  'identifiant_methode_paiement', // par exemple. GatewayType::CREDIT_CARD
  'reference_client_gateway', // facultatif
]
</code></pre>

<h4>4. Traiter une réponse de paiement échoué pour l'utilisateur final</h4>

<p>Un message d'erreur générique est fourni lorsqu'une erreur fatale de passerelle se produit pendant le traitement d'un paiement</p>

<pre><code class="language-php">throw new PaymentFailed('Échec du traitement du paiement.', 500);
</code></pre>

<p>Le long de cette exception, il est également requis que vous lanciez un PaymentFailureMailer::job() défini comme suit</p>

<pre><code class="language-php">PaymentFailureMailer::dipatch($client, $erreur, $entreprise, $payment_hash)
</code></pre>

            <a href="https://github.com/invoiceninja/invoiceninja.github.io/blob/v5-rework/source/fr_CA/payment-gateways.md"
               class="pt-4 border-t inline-flex items-center w-full block">
                <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 24 24" fill="none"
                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                     class="feather feather-github">
                    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
                </svg>
                <span class="ml-2">Want to contribute? Edit this page on GitHub!</span>
            </a>
        </div> <!-- End of main content -->

        <div class="hidden md:block col-span-2 p-4">
            <div class="fixed overflow-y-auto pr-4 h-full pl-4 pb-32 text-sm" id="toc-container">
                <!-- Placeholder for table of contents -->
                <span class="text-sm uppercase block mb-3 text-ninja-blue">On this page</span>
            </div>
        </div>
    </div>
        <script src="/assets/build/js/main.js?id=5d8f1025c2be8c2903a2ea7ba7775489"></script>

    <script>
        document.getElementById('mobile-menu-toggle').addEventListener('click', () => {
            let mobileMenu = document.getElementById('mobile-menu');

            if (mobileMenu.classList.contains('hidden')) {
                return mobileMenu.classList.remove('hidden');
            }

            return mobileMenu.classList.add('hidden');
        });
    </script>

    <!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
    <script type="text/javascript">
        docsearch({
            apiKey: '4816218e8381d5a17beacd84823e9ea3',
            indexName: 'invoiceninja',
            inputSelector: '#topSearchBox',
            debug: false,
            searchParameters: {
                facetFilters: ['language:fr_CA'],
            },
        });
    </script>
        <script type="text/javascript">
        docsearch({
            apiKey: '4816218e8381d5a17beacd84823e9ea3',
            indexName: 'invoiceninja',
            inputSelector: '#indexSearchBox',
            debug: false,
            searchParameters: {
                facetFilters: ['language:fr_CA'],
            },
        });
    </script> -->

<style>
.video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}

.video_container {
    position: relative;
    width: 100%;
    height: 0;
    padding-bottom: 56.25%;
}

</style>
</body>

</html>
